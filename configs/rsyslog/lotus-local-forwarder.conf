# /etc/rsyslog.d/20-lotus-forwarder.conf
#
# Durable local forwarding path:
#   journald -> rsyslog (disk queue) -> lotus tcp:4000
#
# Notes:
# - Keep Lotus on localhost bind (127.0.0.1:4000) unless intentionally exposing it.
# - This config forwards only message payload (%msg%) to keep app JSON intact.
# - action.resumeRetryCount="-1" retries forever while Lotus is down.

module(load="imjournal" StateFile="/var/lib/rsyslog/imjournal.state")
module(load="omfwd")

# Keep original app line as the forwarded payload.
template(name="LotusLine" type="string" string="%msg:::drop-last-lf%\n")

# Prevent accidental loops if Lotus itself logs through journald.
if $programname == "lotus" then {
  stop
}

*.* action(
  name="lotus_forward_tcp"
  type="omfwd"
  target="127.0.0.1"
  port="4000"
  protocol="tcp"
  template="LotusLine"

  # Retry forever while target is unavailable.
  action.resumeRetryCount="-1"
  action.resumeInterval="5"
  action.reportSuspension="on"
  action.reportSuspensionContinuation="on"

  # Durable action queue (disk-assisted).
  queue.type="LinkedList"
  queue.filename="lotus_fwd"
  queue.spoolDirectory="/var/spool/rsyslog"
  queue.maxDiskSpace="10g"
  queue.saveOnShutdown="on"
  queue.dequeueBatchSize="1024"
  queue.size="100000"
  queue.workerThreads="2"
)
